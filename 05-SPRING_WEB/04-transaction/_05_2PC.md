## Giao dịch pahan tán (distribute4d transactions)

## Khái niệm: 

- `Giao dịch phân tán` là một giao dịch logic gồm các thao tác trên `nhiều hệ thống CSDL hoặc tài nguyên khác nhau`. Mỗi hệ thống này có thể hoạt động độc lập, nhưng chúng phải cùng nhau hoàn toàn một công việc duy nhất

- Mục tiêu chính của giao dịch phân tán vẫn là đảm bảo tính chất `ACID`, nhưng lần này alf trên một hệ thống phân tán. Điều này khó khăn hơn nhiều bởi vì: 

- `Lỗi mạng`: kết nối giữa các hệ thống có thể bị gián đoạn
- `Lỗi hệ thống`: một trong các hệ thống tham gia có thể gặp sự cố
- `Thời gian trễ`: các hệ thống có thể có thời gian phản hồi khác nhau

- nếu một giao dịch phân tán không được quản lý đúng cách,  nó có thể dẫn đến `tính nahast quán của dữ liệu bị phá vỡ` trên toàn bộ hệ thống

## Giáo thức Two-Phase commit (2PC)

- Giao thức `Two-PhaseCommit (2PC)` ;à một trong những cách phổ biến nahast để quản lý các giao dịch phân tán. nó đảm bảo tất cả các bên tham gia vào giao dịch dều `commit` (hoàn tất) hoặc `rollback` (hủy bỏ) cùng một lúc. Giao thức này có một `điều phối viên (coordinator)` và `nhiều thành viên` `participants`

## Các giai đoạn

- **GĐ 1: Giai đoạn chuẩn bị (prepare phase)**

    - `1. Điều phối viện` : gửi một yêu cầu `PREPARE` tới các `thành viên`. yêu cầu này đồi hỏi liệu các thành phiên có sẵn sàng để commit giao dịch hay không
    - Mỗi `Thanhf ivene` được thực hiện các thao tác của giao dịch trên hệ thống của mình và lưu trữ kết quả tạm thời

    - mỗi `Thành viên` gửi một phàn hồi trowrl ại `điều phối viên`
        - `YES` Nếu họ commit thành công 
        - `NO` nếu họ không thể

- **Giai đoạn 2: giai đoạn hoàn tất (Commit phase)**
    - `1. Điều phối viên`: tập hợp tất cả các phản hồi
    - `2. Nếu tất cả các thành phiên đều gửi `YES``
        - `Điều phối viên` gửi yêu cầu `COMMIT` tới tất cả các `thành viên`
        - Mỗi `thành viên` hoàn tất giao dịch và lưu thay đổi vĩnh viễn, sau đó gửi lại xác nhận `ACKOWLEDGED`

    - `3. nếu có bất kì thành viên nào gửi _NO_ (hoặc không phản hồi)`
        - `Điều phối viên` gửi yêu cầu `ABORT` (hủy bỏ) tới tất cả các `thành viên`
        - Mỗi `thành viên` hủy bỏ giao dịch, khôi phục lại trạng thái ban đầu và gửi lại xác nhận `ACKNOWLEDGED`

## Nhược điểm của giao thức 2PC

- Mặc dù 2PC đảm bảo tính toàn vẹn, nó có một số nhược điểm lớn, đó là tại sao không phải lúc nào cũng sử dụng được

    - `Tính khả dụng thấp (Low availability)`: nếu `điều phối viên` gặp sự cố sau khi gửi yêu cầu `PREPARE` nhưng trước khi gửi `COMMIT` hoặc `ABORT`. Các `Thành viên` sẽ bị kẹt trong trạng thái chờ. Các tài nguyên của chúng bị khóa và không thể sử dụng được, cho đến khi điều phối viên phục hồi

    - `Hiệu suất kém`: giao thức này yêu cầu nhiều lần giao tiếp mạng và đợi phản hồi, làm tăng độ trễ và giảm hiệu suất

- Vì những lý do này, trong các hệ thống hiện đại đặc biệt là các kiến trúc `microservice`, các nhà phát triển thường chuyển sang mô hình khác như `SagaPattern` để quản lý giao dịch phân tán. Giao dịch Saga không đảm bảo `Atomicity` theo nghĩa truyền thống, nhưng nó cung cấp một cách linh hoạt hơn để xử lý lỗi và duy trì tính nhất quán cuối cùng